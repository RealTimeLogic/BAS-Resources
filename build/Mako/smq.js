(SMQ={utf8:{length:function(n){for(var e=0,t=0;t<n.length;t++){var o=n.charCodeAt(t);2047<o?(55296<=o&&o<=56319&&(t++,e++),e+=3):127<o?e+=2:e++}return e},encode:function(n,e,t){null==e&&(e=new Uint8Array(SMQ.utf8.length(n)));for(var o=t||0,r=0;r<n.length;r++){var i=n.charCodeAt(r);if(55296<=i&&i<=56319){if(lowCharCode=n.charCodeAt(++r),isNaN(lowCharCode))return null;i=(i-55296<<10)+(lowCharCode-56320)+65536}i<=127?e[o++]=i:(i<=2047?e[o++]=i>>6&31|192:(i<=65535?e[o++]=i>>12&15|224:(e[o++]=i>>18&7|240,e[o++]=i>>12&63|128),e[o++]=i>>6&63|128),e[o++]=63&i|128)}return e},decode:function(n,e,t){for(var o,r="",i=(null==e&&(e=0),null==t&&(t=n.length-e),e);i<e+t;){var c=n[i++];if(c<128)o=c;else{var f=n[i++]-128;if(f<0)return null;if(c<224)o=64*(c-192)+f;else{var u=n[i++]-128;if(u<0)return null;if(c<240)o=4096*(c-224)+64*f+u;else{var a=n[i++]-128;if(a<0)return null;if(!(c<248))return null;o=262144*(c-240)+4096*f+64*u+a}}}65535<o&&(o-=65536,r+=String.fromCharCode(55296+(o>>10)),o=56320+(1023&o)),r+=String.fromCharCode(o)}return r}},wsURL:function(n){var e=window.location;return null==n&&(n=e.pathname),("https:"===e.protocol?"wss://":"ws://")+e.hostname+(80!=e.port&&443!=e.port&&0!=e.port.length?":"+e.port:"")+n},websocket:function(){return"WebSocket"in window&&null!=window.WebSocket}}).Client=function(n,s){if(!(this instanceof SMQ.Client))return new SMQ.Client(n,s);arguments.length<2&&"object"==typeof n&&(s=n,n=null);function t(n){var e;if("string"==typeof n){if(!(e=C[n]))throw new Error("tid not found")}else e=n;return e}function o(n,e){var t=new Uint8Array(5);t[0]=n,E(e,t,1),T(t.buffer)}var l,h,r,p=this,d=1,g=1,b=2,D=3,L=4,R=5,F=6,q=7,v=8,y=11,z=12,w=13,B=16,S=18,m=!1,k=(n=n||SMQ.wsURL(),{}),C={},M={},Q={},U={},A={},j={},N={},I=[],W=(s=s||{},function(n,e){return 16777216*n[e]+65536*n[e+1]+256*n[e+2]+n[e+3]}),E=function(n,e,t){e[t]=n>>>24,e[t+1]=n>>>16,e[t+2]=n>>>8,e[t+3]=n},J=function(){for(var n=0;n<I.length;n++)I[n]();I=[]},f=function(n,e,t,o){var r=SMQ.utf8.decode(n);if(!r){if(0==n.length)return"";console.log("Cannot decode UTF8 for tid=",t,", ptid=",e,", subtid=",o),p.onmsg(n,e,t,o)}return r},G=function(n,e,t,o,r){e=f(e,t,o,r);e&&n(e,t,o,r)},H=function(n,e,t,o,r){var i,c=f(e,t,o,r);if(c){try{i=JSON.parse(c)}catch(n){console.log("Cannot parse JSON for tid=",o,", ptid=",t,", subtid=",r),p.onmsg(e,t,o,r)}try{n(i,t,o,r)}catch(n){console.log("Callback failed: "+n+"\n"+n.stack)}}},u=function(n,e,t){var o=!1,r=n[e];return r||(n[e]=r=[],o=!0),r.push(t),o},O=function(){r&&clearTimeout(r),r=null},T=function(n){try{l.send(n)}catch(n){x(n.message,!0)}},c=function(e){try{l=new WebSocket(n)}catch(n){l=null}l?(l.binaryType="arraybuffer",l.onmessage=function(n){O(),V(n,e)},l.onclose=function(n){x("Unexpected socket close",!0)},l.onerror=function(n){x(m?"Socket error":"Cannot connect",!0)}):x("Cannot create WebSocket object",!0)},K=function(t,o,r){function i(){if(--d<=0&&m){for(var n in d=1e4,s){var e=c[n];e&&p.observe(e,s[n])}m?(J(),p.onreconnect&&p.onreconnect(t,o,r)):x("reconnecting failed",!1)}}function n(){if(--g<=0&&m){g=1e4;try{for(var n in a){var e=n==l?"self":c[n];if(e){var t,o=a[n];for(t in o.onmsg&&(d++,p.subscribe(e,{onmsg:o.onmsg,onack:i})),o.subtops){var r=f[t];r&&(d++,p.subscribe(e,r,{onmsg:o.subtops[t],onack:i}))}}}}catch(n){console.log(n.message)}m&&(d-=1e4)<=0&&i()}}var c=k,e=C,f=Q,u=U,a=j,s=N,l=(k={},C={},M={},Q={},U={},A={},j={},N={},h),d=(h=t,1e4),g=1e4;try{for(var b in e)g++,p.create(e[b],n);for(var b in u)g++,p.createsub(u[b],n)}catch(n){}g-=1e4,m&&g<=0&&n()},x=function(n,e){if(l){m=!1;var t=l;l=null;try{t.onopen=t.onmessage=t.onclose=t.onerror=function(){}}catch(n){}try{t.close()}catch(n){}p.onclose&&(t=p.onclose(n,e),e&&"number"==typeof t?r||(t<1e3&&(t=1e3),r=setInterval(function(){l||c(!0)},t)):O())}m=!1},P=function(n){var e,t=new Uint8Array(n.data);switch(t[0]){case R:case q:case S:var o=!t[1],r=W(t,2),i=SMQ.utf8.decode(t,6);o&&(t[0]==S?(Q[r]=i,U[i]=r):(k[r]=i,C[i]=r));var c=(d=t[0]==S?A:M)[i];if(d[i]=null,c)for(var f=0;f<c.length;f++)c[f](o,i,r);break;case v:var r=W(t,1),u=W(t,5),a=W(t,9),s=new Uint8Array(n.data,13),l=(d=j[r])&&((l=d.subtops[a])||d.onmsg)||p.onmsg;l(s,u,r,a);break;case y:1<t.length&&(e=SMQ.utf8.decode(t,1)),x(e||"disconnect",!1);break;case z:t[0]=w,T(t.buffer);break;case w:console.log("pong");break;case B:var r=W(t,1),d=N[r];d&&(l=W(t,5),(i=k[r])||0!=l||(N[r]=null),d(l,i||r));break;default:x("protocol error",!0)}},V=function(n,t){if(l){O();n=new Uint8Array(n.data);if(n[0]==g)if(n[1]==d){var e,o,r,i=W(n,2),c=SMQ.utf8.decode(n,6),f=SMQ.utf8.encode(s.uid||c+i),u=s.info?SMQ.utf8.encode(s.info):null,a=(p.onauth&&(e=(e=p.onauth(i,c))&&SMQ.utf8.encode(e)),new Uint8Array(3+f.length+(e?1+e.length:1)+(u?u.length:0)));for(a[0]=b,a[1]=d,a[2]=f.length,r=0;r<f.length;r++)a[3+r]=f[r];if(o=3+r,e)for(a[o++]=e.length,r=0;r<e.length;r++)a[o++]=e[r];else a[o++]=0;if(u)for(r=0;r<u.length;r++)a[o+r]=u[r];l.onmessage=function(n){var e,n=new Uint8Array(n.data);n[0]==D?0==n[1]?(e=W(n,2),m=!0,l.onmessage=P,t?K(e,i,c):(h=e,J(),p.onconnect&&p.onconnect(h,i,c))):x(SMQ.utf8.decode(n,6),!1):x("protocol error",!1)},T(a.buffer)}else x("Incompatible ver "+n[1],!1);else x("protocol error",!1)}},a=function(n,e,c,f){if(m){"object"==typeof e&&(c=e,e=null),c=c||{};var i,t=function(n,e,t,o,r){var i;c.onack?c.onack(n,e,t,o,r):n||console.log("Denied:",e,t,o,r),!f&&n&&c.onmsg&&(e=(e=j[t])||(j[t]={subtops:{}}),o=c.onmsg,i=o,(n=c.datatype)&&("json"==n?o=function(n,e,t,o){H(i,n,e,t,o)}:"text"==n&&(o=function(n,e,t,o){G(i,n,e,t,o)})),r?e.subtops[r]=o:e.onmsg=o)};if(e&&(i=t,t=function(n,o,r){n?p.createsub(e,function(n,e,t){i(n,o,r,e,t)}):i(n,o,r)}),"self"==n)t(!0,n,h);else if(C[n]&&f)t(!0,n,C[n]);else if("number"==typeof n)C[n]=n,t(!0,k[n]=n,n);else{if("string"!=typeof n)throw new Error("Invalid topic type");u(M,n,t)&&((t=new Uint8Array(SMQ.utf8.length(n)+1))[0]=f?F:L,SMQ.utf8.encode(n,t,1),T(t.buffer))}}else I.push(function(){a(n,e,c,f)})};p.publish=function(n,e,t){if(m){var o;if("string"==typeof n)o=new Uint8Array(SMQ.utf8.length(n)+13),SMQ.utf8.encode(n,o,13);else for(o=new Uint8Array(n.length+13),i=0;i<n.length;i++)o[13+i]=n[i];o[0]=v,E(h,o,5);var r,c,f,u,a=function(){E(c,o,1),E(u,o,9),T(o.buffer)};"string"==typeof e?(c=C[e])||(r=a,a=function(){p.create(e,function(n,e,t){n&&(c=t,r())})}):c=e,t?"string"==typeof t?(u=U[t])||(f=a,a=function(){p.createsub(t,function(n,e,t){n&&(u=t,f())})}):u=t:u=0,a()}else I.push(function(){p.publish(n,e,t)})},p.pubjson=function(n,e,t){p.publish(JSON.stringify(n),e,t)},p.topic2tid=function(n){return C[n]},p.tid2topic=function(n){return k[n]},p.subtopic2tid=function(n){return U[n]},p.tid2subtopic=function(n){return Q[n]},p.disconnect=function(){var n;m&&((n=new Uint8Array(1))[0]=y,l.send(n.buffer),m=!1)},p.subscribe=function(n,e,t){a(n,e,t,!1)},p.create=function(n,e,t){3==arguments.length?a(n,e,{onack:t},!0):a(n,0,{onack:e},!0)},p.createsub=function(n,e){if(m)if(e=e||function(){},U[n])e(!0,n,U[n]);else if("number"==typeof n)U[n]=n,Q[n]=n,e(!0,n,n);else{if("string"!=typeof n)throw new Error("Invalid subtopic type");var t;u(A,n,e)&&((t=new Uint8Array(SMQ.utf8.length(n)+1))[0]=17,SMQ.utf8.encode(n,t,1),T(t.buffer))}else I.push(function(){p.createsub(n,e)})};p.unsubscribe=function(n){n=t(n);j[n]&&(j[n]=null,o(9,n))},p.observe=function(n,e){n=t(n);n==h||N[n]||(N[n]=e,o(14,n))},p.unobserve=function(n){n=t(n);N[n]&&(N[n]=0,o(15,n))},p.gettid=function(){return h},p.getsock=function(){return l},p.onmsg=function(n,e,t,o){console.log("Dropping msg: tid=",t,", ptid=",e,", subtid=",o)},c(!1)};