local a=string.find;local b=string.format;local c=string.gsub;local d=string.match;local e=table.insert;local f=table.concat;local g=ba.urlencode;local h=string.lower;local tonumber=tonumber;local ba=ba;local i=ba.json.encode;local type=type;local _G=_G;local j={}local k;do local l={['&']="&amp;",['<']="&lt;",['>']="&gt;",['"']="&quot;",["'"]="&#x27;",['/']="&#x2F;"}local function m(n)return l[n]end;k=function(o)return c(o,"[&<>\"'/]",m)end end;local p=[[<!DOCTYPE html>
<html lang="en">
<head>
<!-- Generated by the Barracuda Web File Manager; http://www.realtimelogic.com/ -->
<meta http-equiv="content-type" content="text/html;charset=utf-8" />
<link href='/rtl/wfm/style.css' rel='stylesheet' type='text/css' />
<script>window.enableCtxMenu=true;</script>
<script src='/rtl/jquery.js'></script>
<script src='/rtl/wfm/wfm.js'></script>
<title>]]local q=[[</title></head><body><div id="overlaymask"></div><div id='menu'><div>]]local function r(s,t)if s or t then local u={}e(u,"<span id='help'>")if s then e(u,b([[<a id='LogoutB' href='%s' title='Logout'></a>]],s))end;if t then e(u,b([[<a id='HelpB' href='%s' title='Help' target='help'></a>]],t))end;e(u,"</span>")return f(u)end;return""end;local v=[[<span id='menulinks'><a id='RefreshB' href='./' title='Refresh'></a><a id='NewFolderB' href='./?cmd=mkdir' title='Create a new directory'></a><a id='UploadB' href='./?cmd=upload' title='Upload a file from your drive to the remote drive'></a><a id='NewWindowB' href='./' target='_blank' title='Open New Window'></a><a id='SearchB' href='#' title='Search for resources'></a>]]function add2menubuts(w)v=v..w end;local x=[[<a href='#' id='WebDAVB' title='WebDAV session URL'></a>]]local y=[[</span></div><span id='navlink'>Path: ]]function manageMicrosoftClient(cmd,z)return false end;local manageMicrosoftClient=manageMicrosoftClient;local function A(B)if B then return B:gsub("^%s*(.-)%s*$","%1")end end;local function C(D,E)return b("%s/%s",D,E):gsub("//","/")end;local function F(j,cmd,z,G)if davbut then cmd:write(p,G,q,helpdiv,v,x,y)else cmd:write(p,G,q,helpdiv,v,y)end;local D=""local H=""local I={}for J in z:gmatch("([^/]+)")do e(I,J)end;local K=#I;if K>0 then function emitLink(K,E)cmd:write"<a href='"for L=1,K do cmd:write"../"end;cmd:write("'>",E,"</a> / ")end;emitLink(K,"top")for L=1,K-1 do emitLink(K-L,I[L])end;H=I[K]end;cmd:write("</span><span id='curdir'>Directory: ",H,"</span></div>")end;local function M(cmd)cmd:write"</body></html>"end;local function N(j)if jsonrsp or cmd.header and cmd:header"x-requested-with"then return true end;return false end;local function O(j,z)local P;local Q,R=dav:lockmgr(z,true)if Q then P=Q:match"href%s*>([^<]+)<"end;P=P or"unknown"R=R or 0;return P,R end;local function S(j,z)if dav:lockmgr(z)then local P=O(j,z)P=" by "..P or""if not cmd.write then cmd=cmd:response()end;if N(j)then cmd:json{err="noaccess",emsg=b("%s is locked%s.",z,P)}end;cmd:setstatus(403)if txtrsp then cmd:write(z," is locked",P,'.')else F(j,cmd,z,"File Locked")cmd:write("<h1>File Locked</h1><p>",z," is locked",P,".</p>")cmd:write"<p>Press the back button to continue.</p>"M(cmd)end;cmd:abort()end end;local function T(j,U,V,W,X)local function Y(w)local Z=w and#w or 0;cmd:setcontentlength(Z)if w then cmd:send(w,Z)end end;local _=N(j)if _ then cmd:setheader("Content-Type","application/json")end;if V then if _ then Y(i{ok=true})elseif txtrsp then Y"ok"else cmd:setstatus(302)cmd:setheader("Location",url or cmd:url():gsub("[^/]$",""))Y()end else if type(U)=="function"then U=U()end;local a0={invalidname="Invalid name",notfound="Not found",exist="Resource exist",enoent="No such file or directory",noaccess="No file system access",notempty="Directory not empty",ioerror="File system error",nospace="No space left on file system"}local a1=a0[W]a1=a1 or W;if X and#X>1 then a1=b("%s.\n%s",a1,X)end;if _ then cmd:write(i{err=W,emsg=b("%s: %s.",U,a1)})else local a2={invalidname=400,notfound=404,exist=405,enoent=409,noaccess=403,notempty=409,nospace=503}local a3=a2[W]cmd:setstatus(a3 or 503)if txtrsp then cmd:write(b("Operation failed:\n%s.\n%s.",U,a1))else F(j,cmd,"",U)cmd:write("<h1>Operation Failed</h1><p>",U,"<br/>",a1,".</p>")cmd:write"<p>Press the back button to continue.</p>"M(cmd)end end end;cmd:abort()end;local a4;if ba.thread and ba.thread.run then a4=function(j,U,V,W,X)ba.thread.run(function()T(j,U,V,W,X)end)end else a4=T end;local function a5(j,W)if response:committed()then return end;local U,W=W:match"[^:%s]+:%s([^%(]+)%(([^%)]+)"W=W or"noaccess"U=U or W;response:reset"buffer"T(j,U,false,W)end;local function a6(j,U,V,W,X)if V then return end;T(j,U,V,W,X)end;local function a7()end;local a8={["."]=true,[".."]=true,[".DAV"]=true,[".LOCK"]=true}local function a9(E,aa,ab,lockdir,ac,ad)local ae,af=a7,a7;local dav,ag,ah,ai,aj;local helpdiv=""local ak=ba.create.upload(ab)local t;local al="/rtl/wfm/ctxmenu.js"local function am(j,z)cmd:json{uri=t}end;local function an(j,z)local ao;local ap;if aj then local B=cmd:session()ao=B and B:id(true)end;if ao then ap=b("%s%s/%s",ag:baseuri(),ao,z)else tmo=0;ap=b("%s%s",ag:baseuri(),z)end;cmd:json{tmo=ah,uri=ap}end;local function aq(cmd)local aq=cmd:cookie"tzone"if aq then aq=tonumber(aq:value())if aq then return aq*60 end end end;local function ar(j,z)af(j,z,"PROPFIND",false)response:setdefaultheaders()local H=z:match("[^/]*/$")if not H then if#z>0 then return false end;H="top"end;F(j,cmd,z,"Directory "..H)cmd:write"<div id='resources'><div id='fstab'><table><thead><tr><th>Name</th><th>Size</th><th>"local aq=aq(cmd)if aq then cmd:write"Local"else aq=0;cmd:write"UTC"end;cmd:write" Date</th></tr></thead><tbody>"local function as()local dav=dav;for J,at,au,av in ab:files(z,true)do if not a8[J]then local aw=g(at and J.."/"or J)local Z=#J;local ax=dav:lockmgr(z..J)and'<span class="lock"></span>'or''if Z>60 then cmd:write("<tr><td>",ax,"<a href='",aw,"' title='",J,"'>",J:sub(Z-60),"</a></td>")else cmd:write("<tr><td>",ax,"<a href='",aw,"'>",J,"</a></td>")end;if at then cmd:write("<td><img class='dir' src='/rtl/wfm/folder.png' alt='DIR'/></td>")else cmd:write("<td>",av,"</td>")end;cmd:write("<td>",os.date("!%Y-%m-%d %H:%M",au+aq),"</td></tr>\n")end end;return true end;local V,W=pcall(as)if not V then a5(j,W)end;cmd:write"</tbody></table></div></div>"M(cmd)end;local function ay(j,z)jsonrsp=true;af(j,z,"PROPFIND",true)response:setheader("Content-Type","application/json")local az=true;cmd:write"["local function as()for E,at,R,av in ab:files(z,true)do if not a8[E]then if az then az=false else cmd:write","end;cmd:write(i({n=E,s=at and-1 or av,t=R}))end end;return true end;local V,W=pcall(as)if not V then a5(j,W)end;cmd:write"]"end;local function aA(j,z,aB,txtrsp)j.txtrsp=txtrsp;local H=cmd:data"dir"if H and(aB or txtrsp)then z=z..H;af(j,z,"MKCOL")T(j,"Cannot create "..z,ab:mkdir(z))else F(j,cmd,z,"Create Directory")cmd:write("<form method='post'><p>Create a new subdirectory in the ",z," directory.</p><p>Directory name: <input type='text' size='20' name='dir' value=''/></p><input type='Submit' value='Create directory'/></form>")M(cmd)end end;local function aC(j,z)j.txtrsp=true;local w=request:data()local aD,aE=A(w.from),A(w.to)if aD and aE then local aF=ab:stat(z)if aF and aF.isdir then aD=C(z,aD)af(j,aD,"DELETE")af(j,aE,"PUT")local function aG()return b("Cannot rename %s -> %s",aD,aE)end;a6(j,aG,ab:rename(aD,aE:sub(#ag:baseuri())))T(j,nil,true)end end;T(j,z,false,"notfound")end;local function aH(j,z,aI)j.txtrsp=not aI;local aJ;local function aG()return b("Cannot delete %s",aJ)end;local function aK(aL,at)af(j,aL,"DELETE")S(j,aL)aJ=aL;if at then for aM,aN in ab:files(aL,true)do if not a8[aM]then aK(b("%s/%s",aL,aM),aN)end end;a6(j,aG,ab:rmdir(aL))else a6(j,aG,ab:remove(aL))end;return true end;local Z=#z;if z:sub(Z)=="/"then z=z:sub(1,Z-1)end;aJ=z;local aF=ab:stat(z)if aF then local V,W=pcall(aK,z,aF.isdir)if not V then a5(j,W)end;T(j,nil,true)else T(j,aJ,false,"notfound")end end;local function aO(j,z,aB,txtrsp)j.txtrsp=txtrsp;local aL=A(cmd:data("file"))if aL and#aL>0 then if aB and aL then aH(j,z..aL,not txtrsp)else F(j,cmd,z,"Delete Resource")local aF=ab:stat(z..aL)if aF then if aF.isdir then cmd:write("<p>Do you want to delete ",aF.isdir and"directory"or"file"," ",aL,"?</p>")end;cmd:write("<form method='post'><input type='hidden' name='file' value='",aL,"'/><input type='Submit' value='Delete'/></form>")M(cmd)return end end end;local url=cmd:url():gsub("[^/]$","")cmd:sendredirect(url)end;local function aP(j,z,aB)af(j,z,"PUT")F(j,cmd,z,"Upload File")cmd:write("<p>Upload a file to the ",z," directory.</p><form method='post' enctype='multipart/form-data'><p> File: <input type='file' size='40' name='file'/></p><input type='Submit' value='Upload file'/></form>")M(cmd)end;local function aQ(j)response:sendredirect(al)end;local function aR(j,z)local P,R;local E=cmd:data("name")pn=z..E;if dav:lockmgr(pn)then P,R=O(j,pn)else local aF=ab:stat(pn)if aF and aF.isdir then E=E:match"([^/]+)/$"if E then pn=z..E;if dav:lockmgr(pn)then P,R=O(j,pn)end end end end;if P then cmd:json{owner=P,time=R}end;cmd:json{notlocked=true}end;local function aS(j,z)local aT={}for J,aU in request:datapairs()do if J=="n"then local E=z..aU;local aF=ab:stat(E)if aF and not aF.isdir then e(aT,{n=aU,l=dav:lockmgr(E)and O(j,E)or false})end end end;cmd:json{files=aT}end;local function ax(j,z)local R=tonumber(cmd:data"time"or 0)local aV=os.time()if R and R>aV then for J,aU in request:datapairs()do if J=="n"then local E=z..aU;local aF=ab:stat(E)if aF and not aF.isdir and not dav:lockmgr(E)then af(j,E,"PUT")dav:lockmgr(E,cmd,R-aV)end end end end;cmd:json{ok=true}end;local function aW(j,z)for J,aU in request:datapairs()do if J=="n"then local E=z..aU;if dav:lockmgr(E)then af(j,E,"PUT")dav:lockmgr(E,false)end end end;cmd:json{ok=true}end;local aX={helpuri=am,sesuri=an,ls=ar,lj=ay,mkdir=aA,mv=aC,mkdirt=function(j,z,aB)aA(j,z,aB,true)end,rm=aO,rmt=function(j,z,aB)aO(j,z,aB,true)end,upload=aP,ctxmenu=aQ,getlock=aR,getlocks=aS,unlock=aW,lock=ax}local function aY(j,z,aB)local n=cmd:data("cmd")local aZ=aX[n or"ls"]if aZ then return aZ(j,z,aB)end;cmd:senderror(400,b("Unknown command: %s",k(n)))end;local function a_(j,b0)filename=b0:url()..b0:name()cmd=b0;local aL=b0:name()af(j,aL,"PUT")S(j,aL)end;local function b1(j,b0)url=b0:url()cmd=b0:response()txtrsp=true;a4(j,nil,true)end;local function b2(j,b0,U,b3)url=filename or b0:url()cmd=b0:response()a4(j,b("Uploading %s failed",url),false,U,b3)end;local function b4(j,z)af(j,z,"PUT")S(j,z)local b5={rel=z,davbut=davbut,helpdiv=helpdiv}if cmd:header"x-requested-with"then b5.jsonrsp=true else b5.txtrsp=txtrsp end;b5.dav=dav;ak(cmd,z,a_,b1,b2,b5)end;local function b6(j,z)af(j,z,"GET")local aF=ab:stat(z)if not aF then cmd:senderror(404)cmd:abort()end;cmd:setcontentlength(aF.isdir and 0 or aF.size)if aF.isdir then cmd:setheader("BaIsDir","true")else cmd:setcontenttype(ba.mime(z:match("%.(%w+)$")or"bin"))end;cmd:setheader("HttpResMgr","V2.1")cmd:setheader("Etag",b("%04X",aF.mtime))end;local function b7(j,z)local aF=ab:stat(z)if not aF then af(j,z,"GET")T(j,b("Resource %s",k(z)),false,"notfound")end;if aF.isdir then return aY(j,z,false)end;af(j,z,"GET")if cmd:data"download"then local E=d(z,"[^/]*$"):gsub('"','\\"')cmd:setheader("Content-Disposition",b('attachment; filename="%s"',E))cmd:setcontenttype"multipart/form-data"end;return ag:service(cmd,z,true)end;local function b8(j,z)if cmd:header("Content-Type"):find("multipart/form-data",1,true)then return b4(j,z)end;return aY(j,z,true)end;local b9={HEAD=b6,GET=b7,POST=b8,DELETE=aH,PUT=b4}local function bb(j,z,bc)cmd=request;j.davbut=aj;j.helpdiv=helpdiv;j.dav=dav;local bd=request:header"User-Agent"local aZ=b9[request:method()]if aZ then if bd and bd:find("Mozilla",1,true)then if not bc then ae(request,z)end;return aZ(j,z)end end;if aZ~=b8 then if dav:service(cmd,z)then return end end;if aZ then if not bc then ae(request,z)end;return aZ(j,z)end;return false end;local function be(j,z)local B;if not request:user()then local bf;B,bf=ba.session(request,z,true)if B then B:maxinactiveinterval(ah)z=bf elseif manageMicrosoftClient(request,z)then return end end;return bb(j,z,B)end;ag=ba.create.resrdr(E,aa,ab)ag:setfunc(bb)dav=ba.create.dav(E,aa,ab,lockdir,ac,ad)local function bg(bh)aj=ai and ah and true or false;if bh then _G.assert(type(bh)=="function")if aj then local bi=bb;bb=function(j,z,B)return bi(j,bh(j,z,B))end;ag:setfunc(be)else local function bj(j,z)return bb(j,bh(j,z))end;ag:setfunc(bj)end else ag:setfunc(aj and be or bb)end end;local function bk(bl,bm)local function bn(cmd,z)if not bl:authenticate(cmd,z)then cmd:abort()end end;local function bo(j,z,bp)if not bm:authorize(cmd,bp,z)then if#z==0 then z="root"end;if not cmd.write then cmd=cmd:response()end;if N(j)then cmd:json{err="noaccess",emsg=b("You do not have %s access to %s",bp,z)}end;cmd:setstatus(403)if txtrsp then cmd:write("You do not have access to ",z,".")else F(j,cmd,z,"Access denied")cmd:write("<h1>Access denied</h1><p>You do not have access to ",z,".</p>")cmd:write"<p>Press the back button to continue.</p>"M(cmd)end;cmd:abort()end end;ae=bl and bn or a7;af=bm and bo or a7;ai=(bl or bm)and true or false;dav:setauth(bl,bm)bg()end;local function bq(u)if not u.tmo or u.tmo==0 then ah=nil else ah=u.tmo end;t=u.helpuri;al=u.ctxmuri or al;if u.dircmd then for br,aU in _G.pairs(u.dircmd)do aX[br]=aU end end;helpdiv=r(u.logouturi,u.helpuri)bg(u.filterservice)return{authorize=af,io=ab}end;return ag,bk,bq end;local bs={}bs.__index=bs;_G.setmetatable(bs,_G.getmetatable(ba.create.dir()))function bs:setauth(bl,bm)self.dir:setauth(bl,bm)self.auth(bl,bm)end;function bs:configure(bt)return self.cfg(bt)end;function bs:service(bu,z)self.dir:service(bu,z)end;local function bv(bw)local E=nil;local aa=0;local ab;lockdir=nil;local ac=5;local ad=20;local bx=1;if"string"==type(bw[bx])then E=bw[bx]bx=bx+1 end;if"number"==type(bw[bx])then aa=bw[bx]bx=bx+1 end;ab=bw[bx]bx=bx+1;if"string"==type(bw[bx])then lockdir=bw[bx]bx=bx+1 end;if"number"==type(bw[bx])then ac=bw[bx]ad=bw[bx+1]end;return E,aa,ab,lockdir,ac,ad end;function ba.create.wfs(...)local H,bk,bq=a9(bv{...})return _G.setmetatable({dir=H,auth=bk,cfg=bq},bs)end;return j